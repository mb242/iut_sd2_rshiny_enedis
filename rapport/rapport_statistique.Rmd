---
title: |
  <div style="
      text-align:center;
      font-weight:bold;
      font-size:35px;
      color:#FF3333;
      margin-top:34px;
      margin-bottom:14px;
      line-height:1.2em;">
    Analyse des diagnostics de performance √©nerg√©tique (DPE)
  </div>

author: |
  <div style="
      text-align:center;
      font-weight:bold;
      font-size:18px;
      color:#003366;
      margin-bottom:5px;">
    MBAHOUKA Elk-Fred, TCHETCHE Aristide et PHAM Thi Cam Tien
  </div>

date: |
  <div style="
      text-align:left;
      font-size:16px;
      color:#000000;
      margin-bottom:20px;">
    `r format(Sys.time(), '%d/%m/%Y')`
  </div>
params:
  codes_postaux: [ "54000", "34000" ]   
  logement_type: "both"                 
output:
  html_document: 
    toc: true
    toc_float: true
    number_sections: true
    fig_caption: true
    code_folding: hide
    df_print: default
  pdf_document:
    toc: true
---

```{r setup, include=FALSE, message=FALSE}
if(!require(pacman)) install.packages("pacman")
pacman::p_load(
  httr,       
  jsonlite,   
  glue,       
  lubridate,  
  dplyr,      
  corrplot,   
  ggplot2,
  scales,
  forcats,
  patchwork
)

```

```{asis}
<div style="margin:10px 0;">
  <label for="city-select"><strong><i>S√©lectionner une ville pour afficher les donn√©es:</i></strong></label>
  <select id="city-select" style="margin-left:10px;">
    <option value="both" selected>Les deux</option>
    <option value="Nancy">Nancy</option>
    <option value="Montpellier">Montpellier</option>
  </select>
</div>

<script>
(function(){
  function showCity(val) {
    var ids = ['plots-both','plots-nancy','plots-mtp'];
    ids.forEach(function(id){
      var el = document.getElementById(id);
      if (el) el.style.display = 'none';
    });
    if (val === 'Nancy') {
      var e = document.getElementById('plots-nancy'); if (e) e.style.display = 'block';
    } else if (val === 'Montpellier') {
      var e2 = document.getElementById('plots-mtp'); if (e2) e2.style.display = 'block';
    } else {
      var e3 = document.getElementById('plots-both'); if (e3) e3.style.display = 'block';
    }
  }
  var sel = document.getElementById('city-select');
  sel.addEventListener('change', function(){ showCity(this.value); });
  // init
  showCity(sel.value);
})();
</script>

```




```{r include=FALSE}
# importer  les donn√©es 
  "https://raw.githubusercontent.com/mb242/iut_sd2_rshiny_enedis/main/data/logements_nancy.csv",
  header = TRUE,
  fileEncoding = "UTF-8"
)

df_montpellier <- read.csv2(
  "https://raw.githubusercontent.com/mb242/iut_sd2_rshiny_enedis/main/data/logements_montpellier.csv",
  header = TRUE, fileEncoding = "UTF-8"
)

df <- rbind(df_nancy, df_montpellier)



```

___

# **Introduction**
___

- **Contexte** : Face √† la hausse continue des prix de l‚Äô√©nergie et aux enjeux du changement climatique, il est essentiel d‚Äô√©valuer l‚Äôefficacit√© √©nerg√©tique des logements afin de mieux orienter les politiques de r√©novation et de consommation responsable.  

- **Probl√®me** : Les diagnostics de performance √©nerg√©tique (DPE) ne refl√®tent pas toujours fid√®lement les consommations r√©elles des occupants, ce qui peut entra√Æner des d√©cisions inefficaces pour la r√©novation √©nerg√©tique.  

- **Objectif** : Cette √©tude vise √† comparer les valeurs th√©oriques des DPE avec les consommations √©lectriques r√©elles des logements situ√©s √† `Nancy` et `Montpellier`. Ces deux villes ont √©t√© choisies car elles repr√©sentent des climats contrast√©s : Nancy √©tant parmi les villes les plus froides de France, et Montpellier parmi les plus chaudes, ce qui permet d‚Äôanalyser l‚Äôimpact du climat sur la performance √©nerg√©tique.  

- **M√©thode** : Nous utiliserons des analyses statistiques d√©taill√©es sur les donn√©es de consommation et de caract√©ristiques des logements, en classant ces derniers selon leur performance √©nerg√©tique r√©elle.  

- **R√©sultat attendu** : Les r√©sultats permettront de mieux cibler les logements n√©cessitant une r√©novation prioritaire et de proposer des recommandations concr√®tes pour am√©liorer l‚Äôefficacit√© √©nerg√©tique, bas√©es sur des donn√©es fiables.

```{r include=FALSE}
print(table(df))

```

```{r include=FALSE}
# Subsets
df_nancy <- logements_nancy_mtp %>% filter(ville == "Nancy")
df_mtp   <- logements_nancy_mtp %>% filter(ville == "Montpellier")
df_both  <- logements_nancy_mtp
```
___


# **Analyse des KPI √©nerg√©tiques et environnementaux**\n

## **Tableau des KPI √©nerg√©tiques et √©missions de CO‚ÇÇ pour les villes :**
___
- `n_total = nombre de logements`
- `avg_energy = consommation √©nerg√©tique moyenne (kWh/m¬≤/an)`
- `pct_A_C = % de logements performants √©nerg√©tiquement (A-C)`
- `avg_co2 = √©missions moyennes de CO‚ÇÇ (kg/m¬≤/an)`

```{r message=FALSE, warning=FALSE, paged.print=TRUE}
compute_kpi <- function(df_city) {
df%>%
summarise(
n_total = n(),
avg_energy = mean(conso_5_usages_par_m2_ep, na.rm=TRUE),
pct_A_C = sum(etiquette_dpe %in% c("A","B","C"), na.rm=TRUE)/n_total * 100,
avg_co2 = mean(emission_ges_5_usages_par_m2, na.rm=TRUE)
)
}

kpi_nancy <- compute_kpi(df_nancy) %>% mutate(ville="Nancy")
kpi_mtp   <- compute_kpi(df_mtp)   %>% mutate(ville="Montpellier")
kpi_both  <- bind_rows(kpi_nancy, kpi_mtp)

kpi_both

```

## **KPI pertinents :** 
___
- Pour mieux comprendre la performance √©nerg√©tique et l‚Äôimpact environnemental des logements √† Nancy et Montpellier, nous avons calcul√© trois KPI pertinents :

- Ces indicateurs permettent de comparer de mani√®re synth√©tique les villes sur le plan √©nerg√©tique :
  - Consommation √©nerg√©tique moyenne (kWh/m¬≤/an) : refl√®te l‚Äôintensit√© √©nerg√©tique des logements et leur efficience.
  - % de logements DPE A‚ÄìC : montre la proportion de logements consid√©r√©s comme √©nerg√©tiquement performants.
  - √âmissions moyennes de CO‚ÇÇ (kg/m¬≤/an) : √©value l‚Äôimpact environnemental direct li√© au chauffage et √† la consommation d‚Äô√©nergie.

- Le choix de Nancy et Montpellier permet √©galement d‚Äôobserver les diff√©rences climatiques et leur influence sur ces KPI : Nancy √©tant l‚Äôune des villes les plus froides de France, et Montpellier l‚Äôune des plus chaudes. Cette comparaison met en √©vidence comment le climat peut affecter la consommation √©nerg√©tique et les √©missions de CO‚ÇÇ.
```{r}
# KPI 1: Consommation moyenne d'√©nergie ---
p1 <- ggplot(kpi_both, aes(x=ville, y=avg_energy, fill=ville)) +
  geom_col(width=0.4) +
  geom_text(aes(label=round(avg_energy,1)), vjust=-0.3, size=3) +
  labs(title="Consommation √©nerg√©tique\n moyenne (kWh/m¬≤/an)", x=NULL, y="kWh/m¬≤/an") +
  theme_minimal(base_size = 10) +
  scale_fill_manual(values=c("Nancy"="#FF3333", "Montpellier"="#FFD700")) +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        legend.position="none") 


# KPI 2: % logements DPE A‚ÄìC ---
p2 <- ggplot(kpi_both, aes(x=ville, y=pct_A_C, fill=ville)) +
  geom_col(width=0.4) +
  geom_text(aes(label=paste0(round(pct_A_C,1),"%")), vjust=-0.3, size=3) +
  labs(title="% logements DPE A‚ÄìC", x=NULL, y="%") +
  theme_minimal(base_size = 10) +
  scale_fill_manual(values=c("Nancy"="#FF3333", "Montpellier"="#FFD700")) +
  theme(legend.position="bottom")

# KPI 3: √âmissions moyennes de CO‚ÇÇ ---
p3 <- ggplot(kpi_both, aes(x=ville, y=avg_co2, fill=ville)) +
  geom_col(width=0.4) +
  geom_text(aes(label=round(avg_co2,1)), vjust=-0.3, size=3) +
  labs(title="√âmissions moyennes\n de CO‚ÇÇ (kg/m¬≤/an)", x=NULL, y="kg/m¬≤/an") +
  theme_minimal(base_size = 10) +
  scale_fill_manual(values=c("Nancy"="#FF3333", "Montpellier"="#FFD700")) +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),legend.position="none")


p1 + p2 + p3
```
___

# **Exploration des tendances √©nerg√©tiques et structurelles**
___

- Dans cette section, nous interpr√©tons les diff√©rents graphiques pr√©sent√©s pr√©c√©demment pour mieux comprendre les caract√©ristiques du parc immobilier √† Nancy et Montpellier. \n

- L‚Äôobjectif est de d√©gager les tendances principales, d‚Äôidentifier les logements les moins performants et de proposer des actions cibl√©es pour am√©liorer l‚Äôefficacit√© √©nerg√©tique et le confort des logements.

- Nous analysons successivement :
  - R√©partition √©nerg√©tique (√âtiquette DPE) ‚Äî pour visualiser la performance √©nerg√©tique des logements.

  - Surface habitable ‚Äî pour examiner les tailles des logements et leur distribution.

  - Co√ªt du chauffage selon l‚Äô√©tiquette DPE ‚Äî pour comprendre l‚Äôimpact de la performance √©nerg√©tique sur les d√©penses.

  - Corr√©lation surface vs co√ªt chauffage ‚Äî pour √©tudier la relation entre taille du logement et co√ªt √©nerg√©tique.

  - R√©partition logements anciens / neufs ‚Äî pour contextualiser les observations selon l‚Äô√¢ge du parc immobilier.

\n

## **R√©partition √©nerg√©tique**
___
Cette section pr√©sente la distribution des logements par classe DPE (A √† G) pour Nancy, Montpellier, et une comparaison des deux villes, en se basant sur les estimations conventionnelles du DPE.
```{r echo=FALSE, message=FALSE, warning=FALSE}
render_repart_eti_dpe <- function(df_city, suffix = "") {
  
  # couleurs
  couleurs_ville <- list(
    "Nancy" = c("#FF3333", "#B0B0B0"),
    "Montpellier" = c("#007BFF", "#FFD700")
  )
  dpe_summary <- df%>%
    group_by(ville, etiquette_dpe) %>%
    summarise(n = n(), .groups = "drop") %>%
    group_by(ville) %>%
    mutate(pct = n / sum(n) * 100)

  couleurs_dpe <- c(
    "A" = "#009900","B" = "#66CC33","C" = "#FFCC33",
    "D" = "#FF9900","E" = "#FF6600","F" = "#FF3300","G" = "#CC0000"
  )

  print(
    ggplot(dpe_summary, aes(x = ville, y = pct, fill = etiquette_dpe)) +
      geom_bar(stat = "identity", position = "stack") +
      scale_fill_manual(values = couleurs_dpe) +
      labs(title = paste0("R√©partition √©nerg√©tique des logements ", suffix),
           y = "% de logements", x = "Ville") +
      theme_minimal()
  )}
```


```{r message=FALSE, results='asis'}

# ---------- BOTH ----------

cat('<div id="plots-both" style="display:none; margin-bottom:18px;">\n')
render_repart_eti_dpe(df_both, suffix=" (Both)")


# Analysis text for BOTH

cat('

<div style="margin-top:12px; padding:12px; border-left:5px solid #005BAC; background:#FFFFFF;">
  <h4>Analyse ‚Äî Comparaison (Nancy & Montpellier)</h4>
  <p>La comparaison confirme que Nancy fait face √† un d√©fi de r√©novation plus important. La concentration des classes D, E, F, G est nettement sup√©rieure √† Nancy, ce qui justifie la recommandation de prioriser la r√©novation des logements les moins performants dans cette ville.</p>

</div>
')
cat('</div>')

# ---------- NANCY ----------

cat('<div id="plots-nancy" style="display:none; margin-bottom:18px;">')
render_repart_eti_dpe(df_nancy, suffix=" (Nancy)")

# Analysis text for NANCY
cat('

<div style="margin-top:12px; padding:12px; border-left:5px solid #FF3333; background:#FFFFFF;">
  <h4>Analyse ‚Äî Nancy</h4>
  <p><strong>R√©sum√©:</strong> Le parc immobilier de Nancy est moins performant. Une forte proportion de logements (D √† G) montre des consommations √©nerg√©tiques sup√©rieures (‚âà 199 kWh/m¬≤/an) et un besoin de r√©novation important (isolation, chauffage).</p>
</div>
')
cat('</div>')

# ---------- MONTPELLIER ----------
cat('<div id="plots-mtp" style="display:none; margin-bottom:18px;">')
render_repart_eti_dpe(df_mtp, suffix=" (Montpellier)")

# Analysis text for MONTPELLIER
cat('
<div style="margin-top:12px; padding:12px; border-left:5px solid #FFD700; background:#FFFFFF;">
  <h4>Analyse ‚Äî Montpellier</h4>
  <p><strong>R√©sum√©:</strong> Montpellier pr√©sente une meilleure performance √©nerg√©tique, avec une proportion plus √©lev√©e de logements performants (A, B, C) (‚âà 55%). Les consommations moyennes sont plus faibles (‚âà 184 kWh/m¬≤/an). Cela indique un parc plus r√©cent, mais n√©cessite de cibler les copropri√©t√©s anciennes (classes D‚ÄìG).</p>
</div>
')
cat('</div>')

# JS: show/hide the three containers
cat('

<script>
(function(){
  function showCity(val) {
    var ids = ["plots-both","plots-nancy","plots-mtp"];
    ids.forEach(function(id){
      var el = document.getElementById(id);
      if (el) el.style.display = "none";
    });
    if (val === "Nancy") {
      var e = document.getElementById("plots-nancy"); if (e) e.style.display = "block";
    } else if (val === "Montpellier") {
      var e2 = document.getElementById("plots-mtp"); if (e2) e2.style.display = "block";
    } else {
      var e3 = document.getElementById("plots-both"); if (e3) e3.style.display = "block";
    }
  }
  var sel = document.getElementById("city-select");
  sel.addEventListener("change", function(){ showCity(this.value); });
  // init on load
  showCity(sel.value);
})();
</script>

')

```
\n
## **Surface habitable**  
___
Cette visualisation illustre la distribution des surfaces habitables, r√©v√©lant les tendances de taille des logements et les variations entre villes.



```{r}
compute_surface_summary <- function(df_city) {
  df_filtered <- df%>%
    filter(!is.na(surface_habitable_logement) & surface_habitable_logement <= 500)
  df_filtered %>%
    group_by(ville) %>%
    summarise(
      n = n(),
      min = min(surface_habitable_logement, na.rm = TRUE),
      Q1 = quantile(surface_habitable_logement, 0.25, na.rm = TRUE),
      median = median(surface_habitable_logement, na.rm = TRUE),
      mean = mean(surface_habitable_logement, na.rm = TRUE),
      Q3 = quantile(surface_habitable_logement, 0.75, na.rm = TRUE),
      max = max(surface_habitable_logement, na.rm = TRUE),
      sd = sd(surface_habitable_logement, na.rm = TRUE),
      .groups = "drop"
    )
}

if (!exists("summary_nancy") || nrow(summary_nancy) == 0) summary_nancy <- compute_surface_summary(df_nancy)
if (!exists("summary_mtp")   || nrow(summary_mtp) == 0)   summary_mtp   <- compute_surface_summary(df_mtp)
if (!exists("summary_both")  || nrow(summary_both) == 0)  summary_both  <- compute_surface_summary(df_both)

# extraction s√©curis√©e
get_val <- function(tbl, ville_name, col) {
  if (nrow(tbl) == 0) return(NA_real_)
  row <- tbl %>% filter(ville == ville_name)
  if (nrow(row) == 0) return(NA_real_)
  round(row[[col]][1], 1)
}

# extract values
mean_n <- get_val(summary_both, "Nancy", "mean")
med_n  <- get_val(summary_both, "Nancy", "median")
Q1_n   <- get_val(summary_both, "Nancy", "Q1")
Q3_n   <- get_val(summary_both, "Nancy", "Q3")

mean_m <- get_val(summary_both, "Montpellier", "mean")
med_m  <- get_val(summary_both, "Montpellier", "median")
Q1_m   <- get_val(summary_both, "Montpellier", "Q1")
Q3_m   <- get_val(summary_both, "Montpellier", "Q3")

```

```{r echo=FALSE, message=FALSE, warning=FALSE}
render_surface <- function(df_city, suffix = "") {
  logements_filtered <- df%>%
    filter(!is.na(surface_habitable_logement) & surface_habitable_logement <= 500)

  print(
    ggplot(logements_filtered, aes(x = ville, y = surface_habitable_logement, fill = ville)) +
      geom_boxplot(alpha = 0.6, outlier.colour = "red", outlier.shape = 16, outlier.size = 2) +
      scale_fill_manual(values = c("Nancy" = "#FF3333", "Montpellier" = "#FFD700")) +
      coord_cartesian(ylim = c(0, 200)) +
      labs(title = paste0("Surface habitable des logements ", suffix),
           y = "Surface habitable (m¬≤)", x = "Ville") +
      theme_minimal(base_size = 14) +
      theme(legend.position = "none")
  )}
```


```{r message=FALSE, results='asis'}
# ---------- BOTH ----------

cat('<div id="plots-both-surface" style="display:none; margin-bottom:18px;">\n')
render_surface(df_both, suffix=" (Both)")

cat(paste0('
<div style="margin-top:12px; padding:12px; border-left:5px solid #005BAC; background:#FFFFFF;">
  <h4>Analyse ‚Äî Comparaison (Nancy & Montpellier)</h4>
  <p>En comparant les deux villes :</p>
  <ul>
    <li>Surface habitable moyenne √† <strong>Nancy</strong> : ', ifelse(is.na(mean_n),"N/A",paste0(mean_n," m¬≤")), '</li>
    <li>Surface habitable moyenne √† <strong>Montpellier</strong> : ', ifelse(is.na(mean_m),"N/A",paste0(mean_m," m¬≤")), '</li>
  </ul>
  <p>Les logements √† Nancy montrent une plus grande variabilit√© de surfaces.</p>
  <ul>
    <li><strong>Observation :</strong> Les logements petits (&lt; 50 m¬≤) sont plus fr√©quents √† Nancy.</li>
    <li><strong>Recommandation :</strong> Prioriser les r√©novations et l‚Äôam√©lioration de l‚Äôespace habitable dans les logements anciens √† Nancy.</li>
  </ul>
</div>'))
cat('</div>')

# ---------- NANCY ----------

cat('<div id="plots-nancy-surface" style="display:none; margin-bottom:18px;">\n')
render_surface(df_nancy, suffix=" (Nancy)")

cat(paste0('
<div style="margin-top:12px; padding:12px; border-left:5px solid #FF3333; background:#FFFFFF;">
  <h4>Analyse ‚Äî Nancy</h4>
  <p><strong>R√©sum√© :</strong> M√©diane : ', ifelse(is.na(med_n),"N/A",paste0(med_n," m¬≤")), '.  
  L‚Äôintervalle interquartile (Q1‚ÄìQ3) va de ', ifelse(is.na(Q1_n),"N/A",paste0(Q1_n," m¬≤")), ' √† ', ifelse(is.na(Q3_n),"N/A",paste0(Q3_n," m¬≤")), ',
  ce qui indique que la majorit√© des logements se situent dans une tranche de taille moyenne.</p>
  <p><strong>Actions recommand√©es :</strong> Am√©liorer les petits logements, optimiser l‚Äôespace et planifier des r√©novations cibl√©es.</p>
</div>'))
cat('</div>')

# ---------- MONTPELLIER ----------

cat('<div id="plots-mtp-surface" style="display:none; margin-bottom:18px;">\n')
render_surface(df_mtp, suffix=" (Montpellier)")

cat(paste0('
<div style="margin-top:12px; padding:12px; border-left:5px solid #FFD700; background:#FFFFFF;">
  <h4>Analyse ‚Äî Montpellier</h4>
  <p><strong>R√©sum√© :</strong> M√©diane : ', ifelse(is.na(med_m),"N/A",paste0(med_m," m¬≤")), '.  
  La plupart des logements se situent entre ', ifelse(is.na(Q1_m),"N/A",paste0(Q1_m," m¬≤")), ' et ', ifelse(is.na(Q3_m),"N/A",paste0(Q3_m," m¬≤")), '.</p>
  <p><strong>Actions recommand√©es :</strong> Maintenir la qualit√© des logements et cibler les logements plus petits pour des am√©liorations.</p>
</div>'))
cat('</div>')

# JS toggle unique

cat('
<script>
(function(){
  function showSurface(val) {
    var ids = ["plots-both-surface","plots-nancy-surface","plots-mtp-surface"];
    ids.forEach(function(id){
      var el = document.getElementById(id);
      if(el) el.style.display="none";
    });
    if(val === "Nancy") {
      document.getElementById("plots-nancy-surface").style.display="block";
    } else if(val === "Montpellier") {
      document.getElementById("plots-mtp-surface").style.display="block";
    } else {
      document.getElementById("plots-both-surface").style.display="block";
    }
  }
  var sel = document.getElementById("city-select");
  sel.addEventListener("change", function(){ showSurface(this.value); });
  showSurface(sel.value);
})();
</script>
')


```


\n

## **Co√ªt chauffage vs DPE**
___
Ici, on observe la relation entre l‚Äô√©tiquette √©nerg√©tique et le co√ªt de chauffage, ce qui aide √† cibler les logements les plus √©nergivores et √† prioriser les r√©novations.
```{r echo=FALSE, message=FALSE, warning=FALSE}
render_cout_chauf_vs_dpe <- function(df_city, suffix = "") {  
chauffage_filtered <- df%>%
    filter(!is.na(cout_chauffage) & cout_chauffage <= 5000)

  print(
    ggplot(chauffage_filtered, aes(x = etiquette_dpe, y = cout_chauffage, fill = ville)) +
      geom_boxplot(alpha = 0.6, outlier.colour = "red", outlier.shape = 16, outlier.size = 1.5) +
      scale_fill_manual(values = c("Nancy" = "#FF3333", "Montpellier" = "#FFD700")) +
      coord_cartesian(ylim = c(0, 2000)) +
      labs(title = paste0("Co√ªt du chauffage selon l'√©tiquette DPE ", suffix),
           x = "√âtiquette DPE", y = "Co√ªt chauffage (‚Ç¨)") +
      theme_minimal(base_size = 14) +
      theme(legend.position = "bottom")
  )}
```


```{r message=FALSE, results='asis'}
# ---------- BOTH ----------

cat('<div id="plots-both-chauffage" style="display:none; margin-bottom:18px;">\n')
render_cout_chauf_vs_dpe(df_both, suffix=" (Both)")

cat("

<div style='margin-top:12px; padding:12px; border-left:5px solid #005BAC; background:#FFFFFF;'>
  <h4>üá´üá∑ Analyse ‚Äî Comparaison (Nancy & Montpellier)</h4>
  <p><strong>Corr√©lation :</strong> Le DPE est un bon pr√©dicteur du co√ªt de chauffage ; cependant l'√©chelle varie selon le climat.</p>
  <p><strong>Observation :</strong> Pour chaque classe DPE, le co√ªt est syst√©matiquement plus √©lev√© √† Nancy (climat plus froid) qu'√† Montpellier.</p>
  <p><strong>Conclusion :</strong> La classe DPE reste pertinente partout, mais le contexte climatique amplifie l'impact financier √† Nancy. Prioriser les r√©novations pour les classes D‚ÄìG, en particulier √† Nancy.</p>
</div>")
cat('</div>\n')

# ---------- NANCY ----------

cat('<div id="plots-nancy-chauffage" style="display:none; margin-bottom:18px;">\n')
render_cout_chauf_vs_dpe(df_nancy, suffix=" (Nancy)")

cat("

<div style='margin-top:12px; padding:12px; border-left:5px solid #FF3333; background:#FFFFFF;'>
  <h4>üá´üá∑ Analyse ‚Äî Nancy</h4>
  <p><strong>Corr√©lation :</strong> Le DPE est un excellent pr√©dicteur du co√ªt de chauffage √† Nancy.</p>
  <p><strong>Co√ªt (classe F/G) :</strong> Les classes les plus mauvaises affichent des m√©dianes tr√®s √©lev√©es (‚âà 1 100 ‚Ç¨), soulignant l'urgence de la r√©novation.</p>
</div>")
cat('</div>\n')

# ---------- MONTPELLIER ----------

cat('<div id="plots-mtp-chauffage" style="display:none; margin-bottom:18px;">\n')
render_cout_chauf_vs_dpe(df_mtp, suffix=" (Montpellier)")

cat("

<div style='margin-top:12px; padding:12px; border-left:5px solid #FFD700; background:#FFFFFF;'>
  <h4>üá´üá∑ Analyse ‚Äî Montpellier</h4>
  <p><strong>Corr√©lation :</strong> La relation entre DPE et co√ªt est nette mais l'√©chelle des co√ªts est significativement plus basse qu'√† Nancy.</p>
  <p><strong>Co√ªt (classe F/G) :</strong> Les m√©dianes sont mod√©r√©es (‚âà 750‚Äì850 ‚Ç¨), ce qui refl√®te un climat plus doux et un parc plus r√©cent.</p>
</div>")
cat("</div>\n")

# JS: toggle plots Co√ªt chauffage vs DPE

cat('

<script>
(function(){
  function showChauffage(val) {
    var ids = ["plots-both-chauffage","plots-nancy-chauffage","plots-mtp-chauffage"];
    ids.forEach(function(id){
      var el = document.getElementById(id);
      if(el) el.style.display="none";
    });
    if(val === "Nancy") {
      var e = document.getElementById("plots-nancy-chauffage"); if(e) e.style.display="block";
    } else if(val === "Montpellier") {
      var e2 = document.getElementById("plots-mtp-chauffage"); if(e2) e2.style.display="block";
    } else {
      var e3 = document.getElementById("plots-both-chauffage"); if(e3) e3.style.display="block";
    }
  }
  var sel = document.getElementById("city-select");
  sel.addEventListener("change", function(){ showChauffage(this.value); });
  showChauffage(sel.value); // init
})();
</script>

')

```
\n

## **Corr√©lation surface vs co√ªt chauffage**
___
Ce graphique explore l‚Äôimpact de la surface habitable sur le co√ªt de chauffage, mettant en lumi√®re comment taille et consommation √©nerg√©tique interagissent.
```{r echo=FALSE, message=FALSE, warning=FALSE}
render_nuage_plot <- function(df_city, suffix = "") {
df_clean <- df%>%
  filter(cout_chauffage < 5000,
         !is.na(surface_habitable_logement),
         !is.na(cout_chauffage))

is_both <- length(unique(df_city$ville)) > 1

print(ggplot(df_clean, aes(x = surface_habitable_logement,
                           y = cout_chauffage, color = ville)) + geom_point(alpha = 0.4, size = 1.5) +

    # CASE 1: BOTH CITIES SELECTED
    {if (is_both) geom_smooth(
        method = "lm", se = FALSE,
        aes(color = ville),   
        linetype = "solid", size = 1.2
      )
    } +

    # CASE 2: ONE CITY SELECTED
    {if (!is_both)
      geom_smooth(
        method = "lm", se = FALSE,
        color = "#CC0000",   
        linetype = "dashed", size = 1.3
      )
    } +

    scale_color_manual(values = c(
      "Nancy" = "#FF3333",
      "Montpellier" = "#FFD700"
    )) +

    scale_x_continuous(limits = c(0, 300)) +
    scale_y_continuous(limits = c(0, 3000)) +
    labs(
      title = paste0("Relation surface vs co√ªt chauffage ", suffix),
      x = "Surface habitable (m¬≤)",
      y = "Co√ªt du chauffage (‚Ç¨)"
    ) +
    theme_minimal()
)}
```


```{r message=FALSE, warning=FALSE, results='asis'}
# ---------- BOTH ----------

cat('<div id="plots-both-nuage" style="display:none; margin-bottom:18px;">\n')
render_nuage_plot(df_both, suffix=" (Both)")

cat('

<div style="margin-top:12px; padding:12px; border-left:5px solid #005BAC; background:#FFFFFF;">
  <h4>Analyse ‚Äî Comparaison (Nancy & Montpellier)</h4>
  <p>Le nuage de points montre que le co√ªt du chauffage augmente g√©n√©ralement avec la surface habitable. Nancy pr√©sente des co√ªts plus √©lev√©s pour des surfaces similaires compar√©es √† Montpellier.</p>
  <ul>
    <li><strong>Observation:</strong> Les tendances lin√©aires confirment l\'impact de la surface sur le co√ªt du chauffage.</li>
  </ul>
</div>
')
cat('</div>\n')

# ---------- NANCY ----------

cat('<div id="plots-nancy-nuage" style="display:none; margin-bottom:18px;">\n')
render_nuage_plot(df_nancy, suffix=" (Nancy)")

cat('

<div style="margin-top:12px; padding:12px; border-left:5px solid #FF3333; background:#FFFFFF;">
  <h4>Analyse ‚Äî Nancy</h4>
  <p><strong>R√©sum√©:</strong> √Ä Nancy, le co√ªt du chauffage augmente avec la surface. Les logements anciens et grands ont les co√ªts les plus √©lev√©s.</p>
</div>
')
cat('</div>\n')

# ---------- MONTPELLIER ----------

cat('<div id="plots-mtp-nuage" style="display:none; margin-bottom:18px;">\n')
render_nuage_plot(df_mtp, suffix=" (Montpellier)")

cat('

<div style="margin-top:12px; padding:12px; border-left:5px solid #FFD700; background:#FFFFFF;">
  <h4>Analyse ‚Äî Montpellier</h4>
  <p><strong>R√©sum√©:</strong> √Ä Montpellier, le co√ªt du chauffage reste mod√©r√© m√™me pour des logements de grande surface, refl√©tant un parc immobilier plus r√©cent et performant.</p>
</div>
')
cat('</div>\n')

# JS: toggle nuage plots

cat('

<script>
(function(){
  function showNuage(val) {
    var ids = ["plots-both-nuage","plots-nancy-nuage","plots-mtp-nuage"];
    ids.forEach(function(id){
      var el = document.getElementById(id);
      if(el) el.style.display="none";
    });
    if(val === "Nancy") {
      var e = document.getElementById("plots-nancy-nuage"); if(e) e.style.display="block";
    } else if(val === "Montpellier") {
      var e2 = document.getElementById("plots-mtp-nuage"); if(e2) e2.style.display="block";
    } else {
      var e3 = document.getElementById("plots-both-nuage"); if(e3) e3.style.display="block";
    }
  }
  var sel = document.getElementById("city-select");
  sel.addEventListener("change", function(){ showNuage(this.value); });
  showNuage(sel.value); // init
})();
</script>

')

```

\n

## **R√©partition logements anciens / neufs**
___
Cette visualisation compare l‚Äô√¢ge des logements, permettant de distinguer les b√¢timents r√©cents des plus anciens et d‚Äôanticiper les besoins en r√©novation ou modernisation.

```{r echo=FALSE, message=FALSE, warning=FALSE}
render_type_log <- function(df_city, suffix = "") {
df_city_clean <- df%>%
  filter(!is.na(annee_construction)) %>%
  mutate(cat_construction = ifelse(annee_construction < 1960, "Ancien", "Neuf"))

construction_summary <- df_city_clean %>%
  group_by(ville, cat_construction) %>%
  summarise(n = n(), .groups = "drop") %>%
  group_by(ville) %>%
  mutate(pct = n / sum(n) * 100)

cities <- unique(df_city$ville)
is_both <- length(cities) > 1

if (!is_both) {

  city <- cities
  
  if (city == "Nancy") {
    fill_colors <- c(
      "Ancien" = "#B0B0B0",   
      "Neuf"   = "#FF3333"    
    )
  }
  
  if (city == "Montpellier") {
    fill_colors <- c(
      "Ancien" = "#B0B0B0",   
      "Neuf"   = "#FFD700"    
    )
  }

} else {
  
  fill_colors <- c(
    # Nancy
    "Nancy_Ancien" = "#8C8C8C",   
    "Nancy_Neuf"   = "#FF3333",   
    
    # Montpellier
    "Montpellier_Ancien" = "#D6D6D6", 
    "Montpellier_Neuf"   = "#FFD700"  
  )
  
  construction_summary <- construction_summary %>%
    mutate(group = paste0(ville, "_", cat_construction))
}


print(
  ggplot(
    construction_summary,
    aes(
      x = ville,
      y = pct,
      fill = if (is_both) group else cat_construction
    )
  ) +
    geom_bar(stat = "identity", position = "stack") +
    scale_fill_manual(values = fill_colors) +
    geom_text(
      aes(label = paste0(round(pct, 1), "%")),
      position = position_stack(vjust = 0.5),
      color = "white", size = 3.5
    ) +
    labs(
      title = paste0("R√©partition logements anciens / neufs ", suffix),
      x = "Ville", y = "% de logements"
    ) +
    theme_minimal(base_size = 14) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1),
      legend.title = element_blank()
    )
)

}

```


```{r message=FALSE, results='asis'}
# ---------- BOTH ----------

cat('<div id="plots-both-type" style="display:none; margin-bottom:18px;">\n')
render_type_log(df_both, suffix=" (Both)")

cat('

<div style="margin-top:12px; padding:12px; border-left:5px solid #005BAC; background:#FFFFFF;">
  <h4>Analyse ‚Äî Comparaison (Nancy & Montpellier)</h4>
  <p>Le graphique montre la proportion de logements anciens (<1960) et neufs dans les deux villes. Nancy a une part plus importante de logements anciens par rapport √† Montpellier.</p>
  <ul>
    <li><strong>Observation:</strong> Les logements anciens dominent √† Nancy, alors que Montpellier a plus de constructions r√©centes.</li>
  </ul>
</div>
')
cat('</div>\n')

# ---------- NANCY ----------

cat('<div id="plots-nancy-type" style="display:none; margin-bottom:18px;">\n')
render_type_log(df_nancy, suffix=" (Nancy)")

cat('

<div style="margin-top:12px; padding:12px; border-left:5px solid #FF3333; background:#FFFFFF;">
  <h4>Analyse ‚Äî Nancy</h4>
  <p>√Ä Nancy, la majorit√© des logements sont anciens (<1960), ce qui correspond √† un parc immobilier √©nergivore n√©cessitant des r√©novations.</p>
</div>
')
cat('</div>\n')

# ---------- MONTPELLIER ----------

cat('<div id="plots-mtp-type" style="display:none; margin-bottom:18px;">\n')
render_type_log(df_mtp, suffix=" (Montpellier)")

cat('

<div style="margin-top:12px; padding:12px; border-left:5px solid #FFD700; background:#FFFFFF;">
  <h4>Analyse ‚Äî Montpellier</h4>
  <p>√Ä Montpellier, la majorit√© des logements sont r√©cents, le parc immobilier est moderne et performant √©nerg√©tiquement.</p>
</div>
')
cat('</div>\n')

# JS: toggle plots R√©partition logements anciens / neufs

cat('

<script>
(function(){
  function showType(val) {
    var ids = ["plots-both-type","plots-nancy-type","plots-mtp-type"];
    ids.forEach(function(id){
      var el = document.getElementById(id);
      if(el) el.style.display="none";
    });
    if(val === "Nancy") {
      var e = document.getElementById("plots-nancy-type"); if(e) e.style.display="block";
    } else if(val === "Montpellier") {
      var e2 = document.getElementById("plots-mtp-type"); if(e2) e2.style.display="block";
    } else {
      var e3 = document.getElementById("plots-both-type"); if(e3) e3.style.display="block";
    }
  }
  var sel = document.getElementById("city-select");
  sel.addEventListener("change", function(){ showType(this.value); });
  showType(sel.value); // init
})();
</script>

')


```



___

\n
\n
# **Conclusion**
___
L‚Äôanalyse exhaustive des donn√©es immobili√®res et √©nerg√©tiques r√©v√®le des disparit√©s significatives entre les villes √©tudi√©es. √Ä Nancy, le parc immobilier ancien pr√©sente une variabilit√© √©lev√©e et des besoins urgents de r√©novation √©nerg√©tique, tandis qu‚Äô√† Montpellier, les logements sont en moyenne plus r√©cents et mieux performants. L‚Äôint√©gration des indicateurs de surface habitable, de co√ªt √©nerg√©tique et de classe DPE permet non seulement de hi√©rarchiser les priorit√©s en mati√®re de r√©novation, mais aussi de fournir une vision claire et actionable pour la planification urbaine et la transition √©nerg√©tique.\n  

Ce projet montre comment l‚Äôanalyse m√©thodique des donn√©es permet de transformer l‚Äôinformation en d√©cisions concr√®tes, tout en soulignant l‚Äôimportance du contexte local (climat, √¢ge du b√¢ti) pour optimiser les politiques de logement et d‚Äôefficacit√© √©nerg√©tique.



